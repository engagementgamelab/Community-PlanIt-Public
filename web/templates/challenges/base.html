{% extends "layouts/base.html" %}
{% load gmap attachment_tags %}
{% block section %}challenges{% endblock %}
{% block title %}Challenge{% endblock %}
{% block page_title %}{% endblock %}

{% block main %}
<h2>{{challenge.name}}</h2>

<p>{{challenge.description}}</p>

<div>
{% if challenge.is_active %}
    <div class="buttons alignleft">
    {% if not local_player_challenges.completed and not local_player_challenges.accepted %}
        <a class="button" href="{% url challenges_accept challenge.id %}">I'll do it</a>
    {% endif %}
    {% if not local_player_challenges.completed and not local_player_challenges.declined %}
        <a class="button orange" href="{% url challenges_decline challenge.id %}">No thanks</a>
    {% endif %}
    </div>
{% else %}
    {% if challenge.is_expired %}
        This challenge has expired.
    {% else %}
        This challenge has not yet started.
    {% endif %}
{% endif %}
</div>

{{challenge.map|show}}

{% if not local_player_challenges.completed %}
    <p>Provide evidence to complete this challenge:</p>

    <div id="comments">
        <form enctype="multipart/form-data" action="{% url challenges_complete challenge.pk %}" method="POST">
            {% if request.REQUEST.error %}
                <span class="error">Please enter a valid comment.</span>
            {% endif %}

            {% csrf_token %}
            <div id="attachments">
                <div class="controls">
                    Include <a id="add-video" href="#add-video" class="button small">Youtube Video</a> or <a id="add-picture" href="#add-picture" class="button small">Picture</a>
                </div>
                <div class="add-video form">
                    <label for="yt-url">Paste the URL of your YouTube video below. It should look like http://youtu.be/VIDEOID or http://www.youtube.com/watch?v=VIDEOID.</label>
                    <textarea name="yt-url" type="text" maxlength="255"></textarea>
                    <div class="controls">
                        <button class="button small add">add</button>
                        <button type="reset" class="button small reset">remove</button>
                    </div>
                </div>
                <div class="add-picture form">
                    <label for="picture">Picture (max size 5MB):</label> <input name="picture" type="file">
                    <div class="controls">
                        <button class="button small add">add</button>
                        <button type="reset" class="button small reset">remove</button>
                    </div>
                </div>
                <div class="notification"></div>
            </div>
            <textarea name="message" class="comment_message" cols="80" rows="6"></textarea>
            {{comment_form.message.help_text|safe}}
            <button type="submit" class="button submit right">Submit response</button>
            <div style="clear: both;"></div>
        </form>
    </div>
    <hr class="space">
{% endif %}

<h2>Other People's Responses</h2>

{% for pc in challenge.player_challenges.completed %}
{% if pc.player.user.get_profile.avatar %}
        <img class="avatar" src="{{MEDIA_URL}}/{{pc.player.get_profile.avatar}}">
    {% else %}               
        <img class="avatar" src="{{MEDIA_URL}}/img/avatar-blank.jpg">
    {% endif %} 
    {% if pc.attachments.all %}
        <p>
            {{pc.player.get_profile.screen_name}} completed this challenge 
            and provided the following evidence:
        </p>
        <div class="left">
        {% for attachment in pc.attachments.all %}
            {% if attachment.is_valid %}
            <div>
                {% if attachment.type == 'video' %}
                {% youtube_video attachment.url %}
                {% else %}
                <a class="thumbnail" href="{{attachment.file.url}}"><img src="{{attachment.file.url}}"/></a>
                {% endif %}
            </div>
            {% else %}
            <div class="notice">This content is currently unavailable.</div>
            {% endif %}
        {% endfor %}
        </div>
    {% else %}
        <p>
            {{pc.player.get_profile.screen_name}} completed this challenge 
        </p>
    {% endif %}
    {% if pc.response.message %}
    <div class="left">
        <blockquote>{{pc.response.message}}</blockquote>
    </div>
    {% endif %}
    <div style="clear: both;"></div>
{% empty %}
    <p>No one has completed this challenge</p>
{% endfor %}

<div id="comments">
    <h2>Comments</h2>
    {% url challenges_comment challenge.id as comment_post_url %}
    {% with challenge.comments as comments %}
    {% include "comments/post.html" %}
    {% endwith %}
</div>
{% endblock %}

{% block body %}
    {% gmap_includes %}
    <script type="text/javascript">
        $("#complete").bind("click", function(evt) {
            evt.preventDefault();
            
            // Redirect to complete
            window.open("complete/", "_self");

            return false;
        });
    </script>
{% endblock %}
