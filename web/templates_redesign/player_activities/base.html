{% extends "base_city.html" %}
{% load i18n %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}player_activities/css/styles.css">    
{% endblock %}

{% block body_id %}player-activities{% endblock %}

{% block body_class %}{{ block.super }} section-activities{% endblock %}


{% block js %}
    {{ block.super }}
    {# This is some old javascript leftover from the redesign #}
    <script src="{{ STATIC_URL }}js/sijax.js"></script>
    
    {# TODO: Move this to activities/static/activities/js/scripts.js #}
    <script>
    jQuery(function($) {
        // $("#id_activity-btn-submit").live("click", function(event){
        //     event.preventDefault();
        //     $.ajax({
        //             type: "POST",
        //             url: "{% if view_action == 'replay' %} {{ activity.get_replay_url }} {% else %} {{ activity.get_activity_url }} {% endif %}",
        //             data: $('#id_activity-form').serialize(),
        //             success: function(data, textStatus) {
        //                 var $data = $(data);
        //                 var has_errors = $(data).find(".errorlist");
        //     
        //                 if (has_errors.length > 0){
        //                     $('#content').html($data.find('#content'));
        //                 }
        //                 else {
        //                     window.location='{{ activity.get_overview_url }}';
        //                 }
        //             },
        //             error: function(data){                                        
        //                 $('#content').html(data.responseText);
        //             }
        //     });
        // });
        
        $.fn.extend({  
            limit: function(limit,element) {
                var interval, f;
                var self = $(this);
                $(this).focus(function(){
                    interval = window.setInterval(substring,100);
                });
                $(this).blur(function(){
                    clearInterval(interval);
                    substring();
                });
                substringFunction = "function substring(){ var val = $(self).val(); if (val) {var length = val.length;if(length > limit){$(self).val($(self).val().substring(0,limit));}}";
                if(typeof element != 'undefined')
                    substringFunction += "if($(element).html() != limit-length){$(element).html((limit-length<=0)?'0':limit-length);}"
                substringFunction += "}";
                eval(substringFunction);
                substring();

            } 
        }); 


        {% include "js/ajax_csrf.html" %}

        $(".btn-reply").click(function(e){
            e.preventDefault();
            {{ create_comment_sijax_js|safe }}
            var form_data = Sijax.getFormValues('#id_comment-form-'+$(this).attr('id'));
            Sijax.request('create_comment', [form_data]);
        });
        
        
        /* Masonry is a piece of javascript used to layout comments ('bricks') into columns floating left and upwards */
        
        /* Masonry corner stamp modifications */
        $.Mason.prototype.resize = function() {
            this._getColumns();
            this._reLayout();
        };

        $.Mason.prototype._reLayout = function( callback ) {
            var freeCols = this.cols;
            if ( this.options.cornerStampSelector ) {
            var $cornerStamp = this.element.find( this.options.cornerStampSelector ),
                cornerStampX = $cornerStamp.offset().left - 
                  ( this.element.offset().left + this.offset.x + parseInt($cornerStamp.css('marginLeft')) );
            freeCols = Math.floor( cornerStampX / this.columnWidth );
            }

            // reset columns
            var i = this.cols;
            this.colYs = [];
            while (i--) {
            this.colYs.push( this.offset.y );
            }

            for ( i = freeCols; i < this.cols; i++ ) {
            this.colYs[i] = this.offset.y + $cornerStamp.outerHeight(true);
            }

            // apply layout logic to all bricks
            this.layout( this.$bricks, callback );
        };
                
        /* Masonry is used to float the comments into columns correctly */
        init_masonry = function(){
            $('.comments').masonry({
                // options
                itemSelector : '.thread',
                columnWidth : 320,
                cornerStampSelector: '#corner-stamp'
            });
            alert('masonry init!');
        }
        
        init_masonry();
        
        /* This is the character limit counter for response textareas */
        var type_count = function(evt) {
            var comment_form = $(this.form);
            var val = this.value.replace(/\r?\n/g, 'xx');
            var len = Math.max(0, 1000 - val.length);
            comment_form.find('.count').text(len);
            if (len < 1) {
                comment_form.find('.reply-comment-counter').addClass('limited');
                if (!(evt.ctrlKey || evt.which < 48 && evt.which !== 9 && evt.which !== 13)) {
                    return false;
                }
            }
            comment_form.find('.reply-comment-counter').removeClass('limited');
        }
        $('#message_area, #id_response').live('change keyup keydown blur', type_count).attr('maxlength', '1000').change();
        $('#message_area, #id_response').limit('1000','#charsLeft');
    });
    
    
    </script>

    
{% endblock %}
