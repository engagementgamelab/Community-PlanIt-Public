{% extends "accounts/base.html" %}
{% load i18n %}

{% block title %}{% trans "Registration" %}{% endblock %}


{% block extra_head %}
    <script src="{{ STATIC_URL }}js/sijax.js"></script>
    <script type="text/javascript">

    // Read a page's GET URL variables and return them as an associative array.
    function getUrlVars()
    {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }


    city_change_callback = function (commandsArray) {
        Sijax.processCommands(commandsArray);
        $('#id_0-instance').change();
    }

    $(document).ready(function(){

        {% include "js/ajax_csrf.html" %}

        $('#id_0-city').change(function(){
            city_id = $('#id_0-city').val();
            Sijax.setRequestUri("/communities/ajax/load-games-by-city/"+city_id+"/");
            Sijax.request('load_games_by_city', [city_id,], {"success": city_change_callback});
        });

//function(){Sijax.processCommands(); alert('!');

        $('#id_0-instance').change(function(){
            game_id = $('#id_0-instance').val();
            Sijax.setRequestUri("/communities/ajax/load-languages-by-game/"+game_id+"/");
            Sijax.request('load_languages_by_game', [game_id,]);
        });

        $("input[id='id_login-form-submit']").click(function(e){
            e.preventDefault();
            {{ login_sijax_js|safe }}
            var form_data = Sijax.getFormValues('#id_login-form');
            var next =  getUrlVars()["next"];
            Sijax.request('login_process', [form_data, next]);
        });

        $('#id_0-city').change();
    });

    </script>

{% endblock extra_head %}

{% block content %}
<div>
    {% if form.errors or form.non_field_errors or wizard_error %}
    <div id="form_errors" class="error">
        {% trans "Please correct the errors below." %}
        {{form.non_field_errors.as_ul}}
        {{wizard_error}}
    </div>
    {% endif %}
    
    <div>
        <div class="column-half">
            <div class="column-container-40">
                <h2>Sign In</h2>
                <div id="id_login-form-errors" style="color:red;"></div>
                <form class="accounts-form" id="id_login-form" action="{% url accounts:login %}" method="post"> {% csrf_token %}
                    {{ form.as_p}}
                    <div class="clear">
                        <input class="btn-blue submit" id="id_login-form-submit" type="submit" value="Get back to playing!">
                    </div>
                </form>
                
                <br />
                <p style="font-size: 0.9em;">
                    Forgot your password?<br />
                    Please email <a href="mailto:info@communityplanit.org">info@communityplanit.org</a>
                </p>
            </div>
        </div>
        <div class="column-half">
            <div class="column-container-40">
                <h2>Sign Up</h2>
                <form class="accounts-form" action="" method="post"> {% csrf_token %}
                    {{ wizard.management_form }}
                    {% if wizard.form.forms %}
                        {{ wizard.form.management_form }}
                        {% for form in wizard.form.forms %}
                            {{ form.as_p }}
                        {% endfor %}
                    {% else %}
                        {{ wizard.form.as_p }}
                    {% endif %}

            
                    <div class="clear">
                        {% if step == step_count %}
                        <input class="btn submit" type="submit" value="Register">
                        {% else %}
                        <input class="btn submit" type="submit" value="Start Playing!">
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
